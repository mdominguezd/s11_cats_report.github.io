<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.54">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Martín Domínguez Durán">

<title>Cataloguing and visualizing big Geodata – Website</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Website</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
  <li><a href="#internship-organization-background" id="toc-internship-organization-background" class="nav-link" data-scroll-target="#internship-organization-background">Internship organization background</a></li>
  <li><a href="#context-and-justification-of-research" id="toc-context-and-justification-of-research" class="nav-link" data-scroll-target="#context-and-justification-of-research">Context and justification of research</a>
  <ul class="collapse">
  <li><a href="#significance-of-the-topic" id="toc-significance-of-the-topic" class="nav-link" data-scroll-target="#significance-of-the-topic">Significance of the topic</a></li>
  <li><a href="#added-value-of-this-research" id="toc-added-value-of-this-research" class="nav-link" data-scroll-target="#added-value-of-this-research">Added value of this research</a></li>
  </ul></li>
  <li><a href="#research-questions" id="toc-research-questions" class="nav-link" data-scroll-target="#research-questions">Research questions</a></li>
  </ul></li>
  <li><a href="#methodology" id="toc-methodology" class="nav-link" data-scroll-target="#methodology">Methodology</a>
  <ul class="collapse">
  <li><a href="#data-and-processing-code-familiarization" id="toc-data-and-processing-code-familiarization" class="nav-link" data-scroll-target="#data-and-processing-code-familiarization">Data and processing code familiarization</a>
  <ul class="collapse">
  <li><a href="#cloud-services-familiarization" id="toc-cloud-services-familiarization" class="nav-link" data-scroll-target="#cloud-services-familiarization">Cloud services familiarization</a></li>
  </ul></li>
  <li><a href="#baseline-scenario-definition" id="toc-baseline-scenario-definition" class="nav-link" data-scroll-target="#baseline-scenario-definition">Baseline scenario definition</a></li>
  <li><a href="#data-integration" id="toc-data-integration" class="nav-link" data-scroll-target="#data-integration">Data integration</a>
  <ul class="collapse">
  <li><a href="#local-stac-creation-and-browsing" id="toc-local-stac-creation-and-browsing" class="nav-link" data-scroll-target="#local-stac-creation-and-browsing">Local STAC creation and browsing</a></li>
  <li><a href="#sec-structure" id="toc-sec-structure" class="nav-link" data-scroll-target="#sec-structure">Organization of main STAC structure &amp; extensions per asset</a></li>
  <li><a href="#build-main-stac-v.0.1" id="toc-build-main-stac-v.0.1" class="nav-link" data-scroll-target="#build-main-stac-v.0.1">Build main STAC v.0.1</a></li>
  <li><a href="#set-up-stac-browser-on-gcp" id="toc-set-up-stac-browser-on-gcp" class="nav-link" data-scroll-target="#set-up-stac-browser-on-gcp">Set up STAC browser on GCP</a></li>
  <li><a href="#automate-processes-via-ci-pipeline" id="toc-automate-processes-via-ci-pipeline" class="nav-link" data-scroll-target="#automate-processes-via-ci-pipeline">Automate processes via CI pipeline</a></li>
  </ul></li>
  <li><a href="#performance-assessment" id="toc-performance-assessment" class="nav-link" data-scroll-target="#performance-assessment">Performance assessment</a></li>
  </ul></li>
  <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results">Results</a>
  <ul class="collapse">
  <li><a href="#baseline-scenario" id="toc-baseline-scenario" class="nav-link" data-scroll-target="#baseline-scenario">Baseline scenario</a>
  <ul class="collapse">
  <li><a href="#main-findings" id="toc-main-findings" class="nav-link" data-scroll-target="#main-findings">Main findings</a></li>
  </ul></li>
  <li><a href="#service-integration" id="toc-service-integration" class="nav-link" data-scroll-target="#service-integration">Service integration</a></li>
  <li><a href="#multi-format-data-visualization" id="toc-multi-format-data-visualization" class="nav-link" data-scroll-target="#multi-format-data-visualization">Multi-format data visualization</a></li>
  <li><a href="#performance-assessment-1" id="toc-performance-assessment-1" class="nav-link" data-scroll-target="#performance-assessment-1">Performance assessment</a>
  <ul class="collapse">
  <li><a href="#data-discovery" id="toc-data-discovery" class="nav-link" data-scroll-target="#data-discovery">Data discovery</a></li>
  <li><a href="#data-visualization" id="toc-data-visualization" class="nav-link" data-scroll-target="#data-visualization">Data visualization</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#discussion" id="toc-discussion" class="nav-link" data-scroll-target="#discussion">Discussion</a></li>
  <li><a href="#future-work" id="toc-future-work" class="nav-link" data-scroll-target="#future-work">Future work</a></li>
  <li><a href="#internship-planning" id="toc-internship-planning" class="nav-link" data-scroll-target="#internship-planning">Internship planning</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="FinalReport.pdf"><i class="bi bi-file-pdf"></i>PDF (titlepage)</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Cataloguing and visualizing big Geodata</h1>
<p class="subtitle lead">Final report</p>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">Martín Domínguez Durán </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Wageningen University &amp; Research
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
  
    
  </div>
  


</header>


<section id="introduction" class="level1">
<h1>Introduction</h1>
<section id="internship-organization-background" class="level2">
<h2 class="anchored" data-anchor-id="internship-organization-background">Internship organization background</h2>
<p>Satelligence is a company founded in 2016 that specializes in providing satellite-based actionable information by monitoring environmental risks in commodity supply chains and financial investment planning <span class="citation" data-cites="satelligence_home_nodate">(<a href="#ref-satelligence_home_nodate" role="doc-biblioref">Satelligence, n.d.</a>)</span>. More specifically, the company processes terabytes of satellite imagery to detect environmental risks and presents this information to their clients in a web application to assist them in the migration towards more sustainable sourcing models and the compliance with deforestation-free regulations, such as the EUDR <span class="citation" data-cites="satelligence_internship_2023">(<a href="#ref-satelligence_internship_2023" role="doc-biblioref">Satelligence, 2023</a>)</span>.</p>
</section>
<section id="context-and-justification-of-research" class="level2">
<h2 class="anchored" data-anchor-id="context-and-justification-of-research">Context and justification of research</h2>
<p>Satelligence currently employs cloud computing, specifically Kubernetes, to process extensive volumes of satellite imagery amounting to terabytes. While this processing workflow currently runs smoothly, the company’s data team faces challenges when going deeper into the analysis and accessing intermediate results due to the big nature of this data <span class="citation" data-cites="satelligence_internship_2023">(<a href="#ref-satelligence_internship_2023" role="doc-biblioref">Satelligence, 2023</a>)</span>. Scholars have defined big data as datasets characterized by their high Volume, Velocity, and Variety, which makes it paramount to use advanced processing and analytics techniques to derive relevant insights <span class="citation" data-cites="giri_big_2014">(<a href="#ref-giri_big_2014" role="doc-biblioref">Giri and Lone, 2014</a>)</span>. In the specific case of Satelligence, their datasets can be categorized as big data due to their: High volume (Terabytes of satellite images processed every day), high velocity (Near – real time processing of these images) and high variety (Imagery coming from different sensors and regions). All these datasets are a specific case of big data: Big Geodata.</p>
<section id="significance-of-the-topic" class="level3">
<h3 class="anchored" data-anchor-id="significance-of-the-topic">Significance of the topic</h3>
<p>In the past decades there has been a rapid increase in the amount and size of geospatial information that can be accessed. Nowadays, more than 150 satellites orbit the earth collecting thousands of images every single day <span class="citation" data-cites="zhao_scalable_2021">(<a href="#ref-zhao_scalable_2021" role="doc-biblioref">Zhao et al., 2021</a>)</span>. This has made data handling and the introduction of spatial data infrastructures (SDIs) paramount when working with such big datasets.</p>
<p>Traditionally, SDIs have served to ease the accessibility, integration and analysis of spatial data <span class="citation" data-cites="rajabifard_spatial_2001">(<a href="#ref-rajabifard_spatial_2001" role="doc-biblioref">Rajabifard and Williamson, 2001</a>)</span>. However, in practice SDIs have been built upon technologies that focus on data preservation rather than accessibility <span class="citation" data-cites="durbha_advances_2023">(<a href="#ref-durbha_advances_2023" role="doc-biblioref">Durbha et al., 2023</a>)</span>. Due to this, an important shift is underway towards more cloud-based SDIs. These platforms need the emergence of new technologies that prioritize seamless access to cloud-stored data, efficient discovery services that ensure the easy location of extensive spatial data, and data visualization interfaces where multiple datasets can be depicted.</p>
<section id="cloud-based-data-storage" class="level4">
<h4 class="anchored" data-anchor-id="cloud-based-data-storage">Cloud-based data storage</h4>
<p>Spatial data, just like any other type of data, can be catalogued into structured and unstructured data. Structured datasets are often organized and follow a specific structure (i.e.&nbsp;A traditional table with rows (objects) and columns (features)). On the other hand, unstructured data does not have a predefined structure (e.g.&nbsp;Satellite imagery and Time series data) <span class="citation" data-cites="mishra_structured_2017">(<a href="#ref-mishra_structured_2017" role="doc-biblioref">Mishra and Misra, 2017</a>)</span>. The management of structured data has witnessed substantial advancements, making it straightforward to handle it systematically using, for instance, relational databases (i.e.&nbsp;With the help of Structured Query Language (SQL)) <span class="citation" data-cites="kaufmann_database_2023">(<a href="#ref-kaufmann_database_2023" role="doc-biblioref">Kaufmann and Meier, 2023</a>)</span>. In contrast, due to the additional challenges associated with the handling of unstructured data, the developments in this area have taken a longer time to appear.</p>
<p>The emergence of cloud-based archives has been one of the main advancements for unstructured data management during the last decades. In the specific case of geo-spatial data, it has allowed to store terabytes of unstructured data (i.e.&nbsp;Satellite imagery) on the cloud and access it through the network. However, the necessity transmitting data across networks to access it makes it essential to develop new data formats suited for such purposes <span class="citation" data-cites="durbha_advances_2023">(<a href="#ref-durbha_advances_2023" role="doc-biblioref">Durbha et al., 2023</a>)</span>.</p>
<p>Cloud-Optimized GeoTIFFs (<a href="https://www.cogeo.org/">COGs</a>) are an example of data formats that have been created to ease the access of data stored in the cloud. They improve the readability by including the metadata in the initial bytes of the file stored and storing different image tiles for different scales. These characteristics make COGs heavier than traditional image formats, however, they also greatly enhance accessibility by enabling the selective transfer of only the necessary tiles <span class="citation" data-cites="durbha_advances_2023">(<a href="#ref-durbha_advances_2023" role="doc-biblioref">Durbha et al., 2023</a>)</span>.</p>
<p>Another cloud native data format that has gained popularity recently is <a href="https://zarr.readthedocs.io/en/stable/">Zarr</a>. This data format and python library focuses on the cloud-optimization of n-dimensional arrays. Zarr differently than COGs store the metadata separately from the data chunks. Normally, using external JSON files <span class="citation" data-cites="durbha_advances_2023">(<a href="#ref-durbha_advances_2023" role="doc-biblioref">Durbha et al., 2023</a>)</span>.</p>
</section>
<section id="data-discovery-services" class="level4">
<h4 class="anchored" data-anchor-id="data-discovery-services">Data discovery services</h4>
<p>A discovery service widely used for the exploration of big geodata (e.g.&nbsp;COGs) is Spatio-Temporal Asset Catalog (STAC). Through the standardization of spatial data, STAC simplifies the management and discovery of big geodata <span class="citation" data-cites="brodeur_geographic_2019">(<a href="#ref-brodeur_geographic_2019" role="doc-biblioref">Brodeur et al., 2019</a>)</span>. This service works by organizing the data into catalogs, collections, items, and assets that will only be read when a computation is required <span class="citation" data-cites="durbha_advances_2023">(<a href="#ref-durbha_advances_2023" role="doc-biblioref">Durbha et al., 2023</a>)</span>. This feature optimizes workflows by reducing unnecessary data loading.</p>
<section id="stac-fundamentals" class="level5">
<h5 class="anchored" data-anchor-id="stac-fundamentals">STAC fundamentals</h5>
<p>A Catalog built under STAC specifications is composed by:</p>
<table class="table-striped table-hover caption-top table">
<caption>STAC components</caption>
<colgroup>
<col style="width: 55%">
<col style="width: 44%">
</colgroup>
<thead>
<tr class="header">
<th><strong>STAC components</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><em>Assets</em></td>
<td>An asset can be any type of data with a spatial and a temporal component.</td>
</tr>
<tr class="even">
<td><em>Items</em></td>
<td>An item is a GeoJSON feature with some specifications like: Time, Link to the asset (e.g.&nbsp;Google bucket)</td>
</tr>
<tr class="odd">
<td><em>Collections</em></td>
<td>Defines a set of common fields to describe a group of Items that share properties and metadata</td>
</tr>
<tr class="even">
<td><em>Catalogs</em></td>
<td>Contains a list of STAC collections, items or can also contain child catalogs.</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="visualization-interfaces" class="level4">
<h4 class="anchored" data-anchor-id="visualization-interfaces">Visualization interfaces</h4>
<p>The visualization of spatial data brings with it a series of challenges due to its big nature. Dynamic tiling libraries such as TiTiler have tackled multiple of these challenges by dynamically generating PNG/JPEG image tiles only when requested without reading the entire source file into memory <span class="citation" data-cites="noauthor_titiler_nodate">(<a href="#ref-noauthor_titiler_nodate" role="doc-biblioref"><em><span>TiTiler</span></em>, n.d.</a>)</span>. This feature optimizes rendering of images since PNG and JPEG image file formats are more easily transferred through the web.</p>
</section>
</section>
<section id="added-value-of-this-research" class="level3">
<h3 class="anchored" data-anchor-id="added-value-of-this-research">Added value of this research</h3>
<p>This research aims to develop a STAC catalog to facilitate the discovery of diverse big geospatial datasets created by different teams within the company. Depending on the time available for the thesis, data visualization functionalities may be integrated. Moreover, the research will explore tools to efficiently manage a STAC catalog containing both static and dynamic datasets.</p>
</section>
</section>
<section id="research-questions" class="level2">
<h2 class="anchored" data-anchor-id="research-questions">Research questions</h2>
<ul>
<li>What are the current challenges, practices, and user experiences related to data discovery and data visualization in the company?</li>
<li>How does the integration of cloud-optimized data formats, cloud services and SpatioTemporal Asset Catalog (STAC) specifications influence the process and experiences of discovering big spatial data?</li>
<li>To what extent do dynamic tiling services can perform in visualizing different cloud-optimized data formats? <!-- To what extent does the integration of cloud optimized data formats and Spatio-Temporal Asset Catalog (STAC) specifications can reduce times needed for discovering big spatial data produced by the company? --> <!-- -   How can a STAC catalog be structured and updated to improve the discoverability of datasets within a mix of static and dynamic datasets? --></li>
</ul>
</section>
</section>
<section id="methodology" class="level1">
<h1>Methodology</h1>
<p>To address the proposed research questions, a series of activities and the deliverables expected from them are presented on <a href="#fig-fc" class="quarto-xref">Figure&nbsp;1</a>. Additionally, a detailed description of each activity is presented in the following subsections.</p>
<div id="fig-fc" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-fc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/FlowChart_Internship.png" class="img-fluid figure-img" style="width:60.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-fc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Internship flowchart
</figcaption>
</figure>
</div>
<section id="data-and-processing-code-familiarization" class="level2">
<h2 class="anchored" data-anchor-id="data-and-processing-code-familiarization">Data and processing code familiarization</h2>
<p>In this step, I will familiarize myself with the current tools used for the processing of the images and its storage. This step will include the understanding of cloud services and internal image processing tools and the main datasets to be referenced on the catalog (STAC data). Moreover, in this step an initial description of the STAC data metadata will be performed.</p>
<section id="cloud-services-familiarization" class="level3">
<h3 class="anchored" data-anchor-id="cloud-services-familiarization">Cloud services familiarization</h3>
<p>An overview of the cloud services used by the company will be described. This will be mainly with the objective to understand, but not limited to:</p>
<ul>
<li><p>Who access the data?</p></li>
<li><p>What are the costs of accessing it?</p></li>
<li><p>How often certain data is updated?</p></li>
<li><p>How is the data updated?</p></li>
</ul>
</section>
</section>
<section id="baseline-scenario-definition" class="level2">
<h2 class="anchored" data-anchor-id="baseline-scenario-definition">Baseline scenario definition</h2>
<p>The baseline scenario was defined as the set of methods currently being used by members of different teams at Satelligence to find, retrieve and visualize spatial data. This baseline scenario was evaluated qualitatively by interviewing four members of two different teams in the company (i.e.&nbsp;The data and the operations team). To keep a balance regarding experience of the study subjects, both the newest member of each team and a member with at least three years in the company were interviewed.</p>
<p>The questions asked during the interviews were oriented towards two main topics that were covered during this internship: Spatial data discovery and spatial data visualization. For both topics, the questions were divided into questions related to raster and vector datasets. The questions included in the interview can be found in appendix <strong>###</strong> and were meant to be open questions with multiple possible answers.</p>
</section>
<section id="data-integration" class="level2">
<h2 class="anchored" data-anchor-id="data-integration">Data integration</h2>
<section id="local-stac-creation-and-browsing" class="level3">
<h3 class="anchored" data-anchor-id="local-stac-creation-and-browsing">Local STAC creation and browsing</h3>
<p>This step will mainly be focused on the set up of the developing environment to both create a local STAC catalog and browse through it. This will include:</p>
<ol type="1">
<li>Creation of a virtual environment or Docker container with all the required packages to create a STAC catalog.</li>
<li>Creation of Local STAC using sample data from the company.</li>
<li>Browse through the STAC catalog using tools like STAC browser.</li>
</ol>
<p>The <strong>deliverable</strong> of this step will be a GitLab repository with code to create a catalog, add assets from a local directory and browse through them locally using STAC browser.</p>
</section>
<section id="sec-structure" class="level3">
<h3 class="anchored" data-anchor-id="sec-structure">Organization of main STAC structure &amp; extensions per asset</h3>
<p>In this step the structure of the STAC catalog will be defined. This will involve the selection of datasets that will be referenced on the catalog, the definition of subcatalogs and/or collections to group items with similar metadata. An initial idea of the structure of the main STAC catalog can be seen on <a href="#fig-stac-str" class="quarto-xref">Figure&nbsp;2</a>. Initially, the creation of two different subcatalogs is proposed to keep the static and dynamic dataset separated. Moreover, the selection of the <a href="https://stac-extensions.github.io/">STAC extensions</a><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> used for each dataset will be defined in this step.</p>
<div id="fig-stac-str" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-stac-str-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/STAC_Satelligence_structure.png" class="img-fluid figure-img" style="width:90.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-stac-str-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Initial proposed STAC structure
</figcaption>
</figure>
</div>
</section>
<section id="build-main-stac-v.0.1" class="level3">
<h3 class="anchored" data-anchor-id="build-main-stac-v.0.1">Build main STAC v.0.1</h3>
<p>This step will focus on the building of the initial version of the main STAC catalog, once the datasets and the overall structure has been defined. It will involve the population of the catalog with STAC components following the defined structure on <a href="#sec-structure" class="quarto-xref">Section&nbsp;2.3.2</a>. Furthermote, on this step a series of validation tools will be used to check that the STAC catalog created is followins the STAC spcification. These tools are part of the python package <a href="https://github.com/stac-utils/stactools">stac-tools</a>.</p>
<p>The <strong>deliverable</strong> of this step will be a GitLab repository with code to create a catalog, create collections, add assets from a directory on the cloud and update them.</p>
</section>
<section id="set-up-stac-browser-on-gcp" class="level3">
<h3 class="anchored" data-anchor-id="set-up-stac-browser-on-gcp">Set up STAC browser on GCP</h3>
<p>In this step a version of the STAC Browser application will be deployed using the tools from Google Cloud Platform (GCP). This application will allow users to browse and interact with the STAC catalog through a user-friendly interface. Additionally, this step will involve the definition of resources and tools from GCP that will be employed to deploy the application. For instance, the decision of doing it through a virtual machine or on a containerized way will be made.</p>
<p>The <strong>deliverable</strong> of this step will be a the STAC browser application running on GCP.</p>
</section>
<section id="automate-processes-via-ci-pipeline" class="level3">
<h3 class="anchored" data-anchor-id="automate-processes-via-ci-pipeline">Automate processes via CI pipeline</h3>
<p>Finally, the code to create, modify and/or deploy the STAC catalog will be merged into a continuous integration pipeline that will allow the integration of this catalog with other tools from the company. For instance, the Distributed Processing Framework (DPROF), which is satelligence’s Satellite Data Processing engine.</p>
<!-- ### Visualization tool development (Optional)

Finally, if time allows, an internal application will be developed to access and visualize the data from the STAC catalog created.

Required libraries:

-   [Streamlit](https://docs.streamlit.io/) for user interface

-   [Leafmap](https://leafmap.org/) for spatial data visualization

**Deliverable:** Containerized application to visualize the data  -->
</section>
</section>
<section id="performance-assessment" class="level2">
<h2 class="anchored" data-anchor-id="performance-assessment">Performance assessment</h2>
<p>The assessment of the performance of the new Data Catalog will be measured using the baseline scenario established at the beginning of the internship and the Speed Up metric proposed by <span class="citation" data-cites="durbha_advances_2023">(<a href="#ref-durbha_advances_2023" role="doc-biblioref">Durbha et al., 2023</a>)</span>:</p>
<p><span class="math display">\[ SpeedUp = \frac{t_{baseline}}{t_{catalog}} \]</span></p>
<p>This metric explains how much the process to access data has sped up thanks to the integration of cloud-based storage, the data catalog and the browsing interface.</p>
</section>
</section>
<section id="results" class="level1">
<h1>Results</h1>
<section id="baseline-scenario" class="level2">
<h2 class="anchored" data-anchor-id="baseline-scenario">Baseline scenario</h2>
<section id="main-findings" class="level3">
<h3 class="anchored" data-anchor-id="main-findings">Main findings</h3>
<p>The main finding of the interviews were the steps followed currently to discover, retrieve and visualize data. These steps are summarized on <a href="#fig-baseline" class="quarto-xref">Figure&nbsp;3</a> and show how complex and time consuming the process of discovering and visualizing spatial data can be for a Satelligence employee nowadays. Moreover, the steps followed were categorized in four classes depending on how much time is generally spent carrying out.</p>
<div id="fig-baseline" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-baseline-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/Baseline_data_discovery_workflow.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-baseline-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Baseline workflow
</figcaption>
</figure>
</div>
<p>The major pitfalls found on the process of data discovery in the company could be summarized in ….</p>
</section>
</section>
<section id="service-integration" class="level2">
<h2 class="anchored" data-anchor-id="service-integration">Service integration</h2>
<p><em>Explain here how eoAPI uses multiple services, how each of them helps S11 in their data discovery and vizz tasks, and how did I manage to deploy it</em></p>
<p>Kubernetes</p>
<p>STAC-API, pgSTAC, TiTiler</p>
</section>
<section id="multi-format-data-visualization" class="level2">
<h2 class="anchored" data-anchor-id="multi-format-data-visualization">Multi-format data visualization</h2>
<p>TiTiler-PgSTAC &amp; TiTiler-xarray</p>
</section>
<section id="performance-assessment-1" class="level2">
<h2 class="anchored" data-anchor-id="performance-assessment-1">Performance assessment</h2>
<section id="data-discovery" class="level3">
<h3 class="anchored" data-anchor-id="data-discovery">Data discovery</h3>
</section>
<section id="data-visualization" class="level3">
<h3 class="anchored" data-anchor-id="data-visualization">Data visualization</h3>
<p>IDEA: GET requests and time them</p>
<div id="cd11ace5" class="cell" data-execution_count="1">
<div class="cell-output cell-output-stdout">
<pre><code>Speed up (COG) 1.9391304347826084</code></pre>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="FinalReport_files/figure-html/cell-2-output-2.png" width="786" height="398" class="figure-img"></p>
<figcaption>Request times depending on zoom level</figcaption>
</figure>
</div>
</div>
</div>
<!-- 
import requests
import random

tiles = ["9/399/254", "10/800/505", "11/1603/1012",  "12/3209/2042", "13/6407/4075", "14/12817/8159", "15/25678/16271", "16/51268/32552", "17/102503/65134", "18/205062/130211"]

def modify_tile(tile):
    parts = tile.split('/')
    z = int(parts[0])
    x = int(parts[1])
    y = int(parts[2])

    # Determine the range of change based on the value of z
    if z <= 9:
        change_range = 2
    elif z <= 12:
        change_range = 5
    elif z <= 15:
        change_range = 10
    elif z <= 18:
        change_range = 50

    # Apply the change to x and y
    x_change = random.randint(-change_range, change_range)
    y_change = random.randint(-change_range, change_range)

    new_x = x + x_change
    new_y = y + y_change

    # Return the modified tile as a string
    return f"{z}/{new_x}/{new_y}"

times_zarr = []
times_cog = []

z_level = []

cmap = ["=[[[1.0,1.1],[0,47,0,255]],[[2.0,2.1],[55,76,33,255]],[[3.0,3.1],[105,140,60,255]],[[4.0,4.1],[178,199,140,255]],[[5.0,5.1],[164,198,121,255]],[[6.0,6.1],[198,112,85,255]],[[7.0,7.1],[170,219,167,255]],[[8.0,8.1],[87,162,164,255]],[[50.0,50.1],[255,183,1,255]],[[52.0,52.1],[238,223,201,255]],[[53.0,53.1],[185,120,119,255]],[[54.0,54.1],[218,170,241,255]],[[55.0,55.1],[40,205,167,255]],[[60.0,60.1],[208,227,243,255]],[[66.0,66.1],[166,219,204,255]],[[70.0,70.1],[255,255,255,255]],[[71.0,71.1],[185,136,94,255]],[[72.0,72.1],[125,165,142,255]],[[74.0,74.1],[188,85,123,255]],[[90.0,90.1],[241,195,132,255]]]","_name=greens_r&rescale=0,70"]

for i in range(1):

    mod_tiles = [modify_tile(tile) for tile in tiles]
    k = int(i/2-i//2 + 0.5)

    for tile in mod_tiles:

        url_zarr = f"http://localhost:8084/tiles/WebMercatorQuad/{tile}%401x?url=gs://s11-tiles/zarr/separate&variable=band_data&reference=false&decode_times=true&consolidated=true&colormap{cmap[k]}&return_mask=true"

        url_cog = f"http://localhost:8082/collections/Example%20FBL%20Riau/items/FBL_V5_2021_Riau_cog/tiles/WebMercatorQuad/{tile}%401x?bidx=1&assets=data&unscale=false&resampling=nearest&reproject=nearest&colormap{cmap[k]}&return_mask=true"

        x = requests.get(url_zarr)
        times_zarr.append(x.elapsed.total_seconds())

        x = requests.get(url_cog)
        times_cog.append(x.elapsed.total_seconds())

        z_level.append(int(tile.split('/')[0]))

sns.set_style('ticks')

fig = plt.figure(figsize = (10,7))

sns.regplot(x = z_level, y=times_cog)
sns.regplot(x = z_level, y=times_zarr)

Z_level = [12, 18, 14]
 -->
</section>
</section>
</section>
<section id="discussion" class="level1">
<h1>Discussion</h1>
</section>
<section id="future-work" class="level1">
<h1>Future work</h1>
</section>
<section id="internship-planning" class="level1">
<h1>Internship planning</h1>
<p><strong>Internship duration:</strong> 08/04/2024 - 08/08/2024 (4 months)</p>
</section>
<section id="references" class="level1">
<h1>References</h1>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" data-line-spacing="2" role="list">
<div id="ref-brodeur_geographic_2019" class="csl-entry" role="listitem">
Brodeur, J., Coetzee, S., Danko, D., Garcia, S. and Hjelmager, J. (2019). Geographic <span>Information</span> <span>Metadata</span>—<span>An</span> <span>Outlook</span> from the <span>International</span> <span>Standardization</span> <span>Perspective</span>. <em>ISPRS International Journal of Geo-Information</em>, <em>8</em>(6), 280. p. <a href="https://doi.org/10.3390/ijgi8060280">https://doi.org/10.3390/ijgi8060280</a>
</div>
<div id="ref-durbha_advances_2023" class="csl-entry" role="listitem">
Durbha, S. S., Sanyal, J., Yang, L., S Chaudhari, S., Bhangale, U., Bharambe, U. and Kurte, K. (2023). <em>Advances in <span>Scalable</span> and <span>Intelligent</span> <span>Geospatial</span> <span>Analytics</span>: <span>Challenges</span> and <span>Applications</span></em> (1st ed.). CRC Press. <a href="https://doi.org/10.1201/9781003270928">https://doi.org/10.1201/9781003270928</a>
</div>
<div id="ref-giri_big_2014" class="csl-entry" role="listitem">
Giri, K. and Lone, T. (2014). Big <span>Data</span> -<span>Overview</span> and <span>Challenges</span>. <em>International Journal of Advanced Research in Computer Science and Software Engineering</em>, <em>4</em>.
</div>
<div id="ref-kaufmann_database_2023" class="csl-entry" role="listitem">
Kaufmann, M. and Meier, A. (2023). Database <span>Management</span>. In M. Kaufmann and A. Meier (Eds.), <em><span>SQL</span> and <span>NoSQL</span> <span>Databases</span>: <span>Modeling</span>, <span>Languages</span>, <span>Security</span> and <span>Architectures</span> for <span>Big</span> <span>Data</span> <span>Management</span></em> (1–24. pp.). Springer Nature Switzerland. <a href="https://doi.org/10.1007/978-3-031-27908-9_1">https://doi.org/10.1007/978-3-031-27908-9_1</a>
</div>
<div id="ref-mishra_structured_2017" class="csl-entry" role="listitem">
Mishra, S. and Misra, A. (2017). Structured and <span>Unstructured</span> <span>Big</span> <span>Data</span> <span>Analytics</span>. <em>2017 <span>International</span> <span>Conference</span> on <span>Current</span> <span>Trends</span> in <span>Computer</span>, <span>Electrical</span>, <span>Electronics</span> and <span>Communication</span> (<span>CTCEEC</span>)</em>, 740–746. pp. <a href="https://doi.org/10.1109/CTCEEC.2017.8454999">https://doi.org/10.1109/CTCEEC.2017.8454999</a>
</div>
<div id="ref-rajabifard_spatial_2001" class="csl-entry" role="listitem">
Rajabifard, A. and Williamson, I. P. (2001). <em>Spatial data infrastructures: Concept, <span>SDI</span> hierarchy and future directions</em>. <a href="http://hdl.handle.net/11343/33897">http://hdl.handle.net/11343/33897</a>
</div>
<div id="ref-satelligence_home_nodate" class="csl-entry" role="listitem">
Satelligence. (n.d.). Home - <span>Satelligence</span> - <span>Sustainability</span> monitoring simplified. In <em>Satelligence</em>. Retrieved February 5, 2024, from <a href="https://satelligence.com/">https://satelligence.com/</a>
</div>
<div id="ref-satelligence_internship_2023" class="csl-entry" role="listitem">
Satelligence. (2023). <em>Internship: <span>Cataloguing</span> and visualizing big geodata</em>.
</div>
<div id="ref-noauthor_titiler_nodate" class="csl-entry" role="listitem">
<em><span>TiTiler</span></em>. (n.d.). Retrieved February 19, 2024, from <a href="https://developmentseed.org/titiler/">https://developmentseed.org/titiler/</a>
</div>
<div id="ref-zhao_scalable_2021" class="csl-entry" role="listitem">
Zhao, Y., Yang, X. and Vatsavai, R. R. (2021). A <span>Scalable</span> <span>System</span> for <span>Searching</span> <span>Large</span>-scale <span>Multi</span>-sensor <span>Remote</span> <span>Sensing</span> <span>Image</span> <span>Collections</span>. <em>2021 <span>IEEE</span> <span>International</span> <span>Conference</span> on <span>Big</span> <span>Data</span> (<span>Big</span> <span>Data</span>)</em>, 3780–3783. pp. <a href="https://doi.org/10.1109/BigData52589.2021.9671679">https://doi.org/10.1109/BigData52589.2021.9671679</a>
</div>
</div>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>STAC extensions are additional metadata properties that can be added to a dataset. (e.g.&nbsp;Classes, bands, sensor-type, etc.)<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/mdominguezd\.github\.io\/s11_cats_report\.github\.io\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>